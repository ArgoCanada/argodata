<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Virtual moorings and sections • argodata</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Virtual moorings and sections">
<meta property="og:description" content="argodata">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">argodata</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/virtual-mooring.html">Virtual moorings and sections</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ArgoCanada/argodata/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="virtual-mooring_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Virtual moorings and sections</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ArgoCanada/argodata/blob/master/vignettes/articles/virtual-mooring.Rmd"><code>vignettes/articles/virtual-mooring.Rmd</code></a></small>
      <div class="hidden name"><code>virtual-mooring.Rmd</code></div>

    </div>

    
    
<p>We’ll start by loading a few packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ArgoCanada/argodata">argodata</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">tidyverse</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span>
<span class="fu">theme_set</span><span class="op">(</span><span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div id="fetch" class="section level2">
<h2 class="hasAnchor">
<a href="#fetch" class="anchor"></a>Fetch</h2>
<p>The first step is to choose which area is representative of the region for which you would like to create an aggregated/summarized set of profiles. One way to do this is using a point and radius, for which <code><a href="../../reference/argo_filter_radius.html">argo_filter_radius()</a></code> is provided to subset the global profile index <code><a href="../../reference/argo_global_meta.html">argo_global_prof()</a></code>. For example, the following point/radius results in approximately 475 profiles between Labrador and Greenland in the Labrador Sea. For the purposes of the virtual mooring, the radius needs to be small enough that the profiles are related to the conditions in the region you are attempting to model and large enough that there are enough profiles for window point of time you would like to model.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mooring_lat</span> <span class="op">&lt;-</span> <span class="fl">55.7</span>
<span class="va">mooring_lon</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">49.5</span>
<span class="va">mooring_radius_km</span> <span class="op">&lt;-</span> <span class="fl">150</span></code></pre></div>
<p>The next step is to (optionally) choose a window of time to consider. For the purposes of this article, we’ll consider the years between 2011 and 2019, inclusive.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mooring_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2011-01-01"</span><span class="op">)</span>
<span class="va">mooring_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2019-12-31"</span><span class="op">)</span></code></pre></div>
<p>Finally, it is worth considering whether or not the “realtime” or “delayed” data sets best suits your use-case. The delayed data set is more likely to have poor-quality measurements corrected; however, the realtime data set may have more profiles available. You should pick one or the other to avoid double-counting profiles collected by the same float! In this article we will use the realtime data set.</p>
<p>An index of all profiles available from the Argo program is available by calling <code><a href="../../reference/argo_global_meta.html">argo_global_prof()</a></code>. This will take 20-60 seconds to load depending on your internet connection; if you would like to avoid downloading the index file more than once you can <a href="https://github.com/ArgoCanada/argodata#installation">configure a persistent cache directory</a>, but be aware that this index is updated frequently.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">profiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/argo_global_meta.html">argo_global_prof</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../../reference/argo_filter_radius.html">argo_filter_radius</a></span><span class="op">(</span>
    latitude <span class="op">=</span> <span class="va">mooring_lat</span>,
    longitude <span class="op">=</span> <span class="va">mooring_lon</span>,
    radius_km <span class="op">=</span> <span class="va">mooring_radius_km</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../../reference/argo_filter_radius.html">argo_filter_date</a></span><span class="op">(</span>
    date_min <span class="op">=</span> <span class="va">mooring_start</span>,
    date_max <span class="op">=</span> <span class="va">mooring_end</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../../reference/argo_filter_radius.html">argo_filter_data_mode</a></span><span class="op">(</span><span class="st">"realtime"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../../reference/argo_path_info.html">argo_extract_path_info</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">file</span>, <span class="va">file_float</span>, <span class="va">date</span>, <span class="va">latitude</span>, <span class="va">longitude</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>

<span class="va">profiles</span>
<span class="co">#&gt; [90m# A tibble: 216 x 14[39m</span>
<span class="co">#&gt;    file  file_float date                latitude longitude file_type file_cycle</span>
<span class="co">#&gt;    [3m[90m&lt;chr&gt;[39m[23m [3m[90m&lt;chr&gt;[39m[23m      [3m[90m&lt;dttm&gt;[39m[23m                 [3m[90m&lt;dbl&gt;[39m[23m     [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;chr&gt;[39m[23m          [3m[90m&lt;int&gt;[39m[23m</span>
<span class="co">#&gt; [90m 1[39m meds… 4901167    2011-07-03 [90m12:58:00[39m     56.1     -[31m51[39m[31m.[39m[31m8[39m prof               6</span>
<span class="co">#&gt; [90m 2[39m meds… 4901167    2011-07-13 [90m14:27:00[39m     56.3     -[31m51[39m[31m.[39m[31m5[39m prof               7</span>
<span class="co">#&gt; [90m 3[39m meds… 4901167    2011-07-23 [90m12:54:00[39m     56.2     -[31m51[39m[31m.[39m[31m4[39m prof               8</span>
<span class="co">#&gt; [90m 4[39m meds… 4901163    2011-07-30 [90m17:58:00[39m     56.7     -[31m48[39m[31m.[39m[31m6[39m prof               8</span>
<span class="co">#&gt; [90m 5[39m meds… 4901167    2011-08-02 [90m14:32:00[39m     56.0     -[31m51[39m[31m.[39m[31m1[39m prof               9</span>
<span class="co">#&gt; [90m 6[39m meds… 4901163    2011-08-09 [90m16:16:00[39m     56.8     -[31m48[39m[31m.[39m[31m7[39m prof               9</span>
<span class="co">#&gt; [90m 7[39m meds… 4901167    2011-08-12 [90m13:01:00[39m     55.8     -[31m51[39m[31m.[39m[31m0[39m prof              10</span>
<span class="co">#&gt; [90m 8[39m meds… 4901163    2011-08-19 [90m16:41:00[39m     56.8     -[31m49[39m[31m.[39m[31m1[39m prof              10</span>
<span class="co">#&gt; [90m 9[39m meds… 4901167    2011-08-22 [90m14:24:00[39m     56.5     -[31m50[39m[31m.[39m[31m2[39m prof              11</span>
<span class="co">#&gt; [90m10[39m meds… 4901163    2011-08-29 [90m18:08:00[39m     56.7     -[31m49[39m[31m.[39m[31m3[39m prof              11</span>
<span class="co">#&gt; [90m# … with 206 more rows, and 7 more variables: file_data_mode [3m[90m&lt;chr&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   file_modifier [3m[90m&lt;chr&gt;[90m[23m, file_descending [3m[90m&lt;lgl&gt;[90m[23m, ocean [3m[90m&lt;chr&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   profiler_type [3m[90m&lt;dbl&gt;[90m[23m, institution [3m[90m&lt;chr&gt;[90m[23m, date_update [3m[90m&lt;dttm&gt;[90m[23m[39m</span></code></pre></div>
<p>A good sanity check is to examine the distribution of profiles in space and time, as we’ll be spending a lot of time examining the interactions between these dimensions. Below I’ve created a bar plot to examine the distribution of profiles both within and between years: there is a lot of variability! We will come back to this later on.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>
  <span class="va">profiles</span>,
  <span class="fu">aes</span><span class="op">(</span>
    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span>,
    fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_bar</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="virtual-mooring_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>For a quick view of the locations I used the <a href="https://github.com/paleolimbot/ggspatial">ggspatial</a> package:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://paleolimbot.github.io/ggspatial">ggspatial</a></span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">profiles</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">longitude</span>, y <span class="op">=</span> <span class="va">latitude</span>, col <span class="op">=</span> <span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_map_tile.html">annotation_map_tile</a></span><span class="op">(</span>zoomin <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, progress <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/geom_spatial_rect.html">geom_spatial_rect</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="fl">50</span>, ymax <span class="op">=</span> <span class="fl">65</span>, xmin <span class="op">=</span> <span class="op">-</span><span class="fl">70</span>, xmax <span class="op">=</span> <span class="op">-</span><span class="fl">30</span><span class="op">)</span>,
    fill <span class="op">=</span> <span class="cn">NA</span>,
    <span class="co"># data = tibble(x = NA),</span>
    inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>,
    crs <span class="op">=</span> <span class="fl">4326</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/stat_spatial_identity.html">geom_spatial_point</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="virtual-mooring_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>You can use plots like this to ensure that you have a reasonable density of samples in both space and time for the question you are trying to answer. Once you’ve done this, you can load profile levels using <code><a href="../../reference/argo_prof_levels.html">argo_prof_levels()</a></code>. This will download the files from the Argo server and load them into a table with one row per profile per sampling level. This will take about 90 seconds depending on your internet connection and system configuration (if you do this often, see <code><a href="../../reference/argo_map.html">argo_set_mapper()</a></code> for how to use multiple cores on your computer to do this faster).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/argo_prof_levels.html">argo_prof_levels</a></span><span class="op">(</span><span class="va">profiles</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">file</span>, <span class="va">date</span>, <span class="va">pres</span>, <span class="va">temp</span>, <span class="va">temp_qc</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Downloading 216 files from 'https://data-argo.ifremer.fr'</span>
<span class="co">#&gt; Extracting from 216 files</span>

<span class="va">levels</span>
<span class="co">#&gt; [90m# A tibble: 233,909 x 20[39m</span>
<span class="co">#&gt;    file  date                 pres  temp temp_qc n_prof cycle_number n_levels</span>
<span class="co">#&gt;    [3m[90m&lt;chr&gt;[39m[23m [3m[90m&lt;dttm&gt;[39m[23m              [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;chr&gt;[39m[23m    [3m[90m&lt;int&gt;[39m[23m        [3m[90m&lt;int&gt;[39m[23m    [3m[90m&lt;int&gt;[39m[23m</span>
<span class="co">#&gt; [90m 1[39m meds… 2011-07-03 [90m12:58:00[39m  6.70  7.24 1            1            6        1</span>
<span class="co">#&gt; [90m 2[39m meds… 2011-07-03 [90m12:58:00[39m 10.8   6.83 1            1            6        2</span>
<span class="co">#&gt; [90m 3[39m meds… 2011-07-03 [90m12:58:00[39m 20.1   5.51 1            1            6        3</span>
<span class="co">#&gt; [90m 4[39m meds… 2011-07-03 [90m12:58:00[39m 30.2   3.85 1            1            6        4</span>
<span class="co">#&gt; [90m 5[39m meds… 2011-07-03 [90m12:58:00[39m 40.5   3.68 1            1            6        5</span>
<span class="co">#&gt; [90m 6[39m meds… 2011-07-03 [90m12:58:00[39m 49.9   3.88 1            1            6        6</span>
<span class="co">#&gt; [90m 7[39m meds… 2011-07-03 [90m12:58:00[39m 59.8   4.01 1            1            6        7</span>
<span class="co">#&gt; [90m 8[39m meds… 2011-07-03 [90m12:58:00[39m 69     3.95 1            1            6        8</span>
<span class="co">#&gt; [90m 9[39m meds… 2011-07-03 [90m12:58:00[39m 80.6   3.63 1            1            6        9</span>
<span class="co">#&gt; [90m10[39m meds… 2011-07-03 [90m12:58:00[39m 90.6   3.94 1            1            6       10</span>
<span class="co">#&gt; [90m# … with 233,899 more rows, and 12 more variables: pres_qc [3m[90m&lt;chr&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   pres_adjusted [3m[90m&lt;dbl&gt;[90m[23m, pres_adjusted_qc [3m[90m&lt;chr&gt;[90m[23m, pres_adjusted_error [3m[90m&lt;dbl&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   temp_adjusted [3m[90m&lt;dbl&gt;[90m[23m, temp_adjusted_qc [3m[90m&lt;chr&gt;[90m[23m, temp_adjusted_error [3m[90m&lt;dbl&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   psal [3m[90m&lt;dbl&gt;[90m[23m, psal_qc [3m[90m&lt;chr&gt;[90m[23m, psal_adjusted [3m[90m&lt;dbl&gt;[90m[23m, psal_adjusted_qc [3m[90m&lt;chr&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   psal_adjusted_error [3m[90m&lt;dbl&gt;[90m[23m[39m</span></code></pre></div>
</div>
<div id="clean" class="section level2">
<h2 class="hasAnchor">
<a href="#clean" class="anchor"></a>Clean</h2>
<p>Again, the first step once we have the data is to plot! Here I’ve coloured the points by the <code>_qc</code> column for temperature, since temperature is what we’ll be examining later on. There is a <code>_qc</code> column for most variables in the levels table; you can learn more about what each flag means in the <code>argo_reference_qc_flag</code> table or the <a href="https://doi.org/10.13155/29825">Argo User’s Manual</a>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">levels</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">pres</span>, x <span class="op">=</span> <span class="va">temp</span>, col <span class="op">=</span> <span class="va">temp_qc</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_y_reverse</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 170850 rows containing missing values (geom_point).</span></code></pre></div>
<p><img src="virtual-mooring_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>From this plot it’s clear that there are some points with clearly bad values that we need to take care of. A similar plot of <code>pres_qc</code> indicates that there are some bad pressure values as well. Depending what stage you are at in your analysis, you may want to remove rows that you can’t use in future analysis or set these values to <code>NA</code>. I’ll demonstrate the latter here using <code><a href="../../reference/argo_qc_censor_if_not.html">argo_qc_censor_if_not()</a></code>, which sets values to <code>NA</code> where the paired <code>_qc</code> column is not in a specified vector of values. The only value that makes sense to keep based on a plot of our results is <code>1</code>, which corresponds to “good data” in the reference table (beware that not all data marked “good” has been checked with the same degree of scrutiny!).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">levels_clean</span> <span class="op">&lt;-</span> <span class="va">levels</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../../reference/argo_qc_censor_if_not.html">argo_qc_censor_if_not</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">pres</span><span class="op">)</span>, qc_flag <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>

<span class="va">levels_clean</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.finite</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.finite</a></span><span class="op">(</span><span class="va">pres</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">pres</span>, x <span class="op">=</span> <span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_y_reverse</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="virtual-mooring_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
<div id="model" class="section level2">
<h2 class="hasAnchor">
<a href="#model" class="anchor"></a>Model</h2>
<div id="binaggregate" class="section level3">
<h3 class="hasAnchor">
<a href="#binaggregate" class="anchor"></a>Bin/Aggregate</h3>
<p>Combining information collected at specific locations over time is an entire subfield of spatial statistics. For our purposes, binning and aggregating along a few dimensions of interest is probably sufficient and should always be attempted before invoking a more complex method.</p>
<p>There are a few complexities associated with combining information from multiple profiles. Notably, there is a severe sampling bias: the nature of the Argo float is such that it collects detailed data along its trajectory which is clumped in both space and time. This means that certain areas and timeframes are intensely sampled whereas other areas and/or timeframes may have poor coverage. Another complexity is that certain locations may represent the “virtual mooring” location or region poorly.</p>
<p>We will mitigate the effects of both these complicating behaviours using weighting. To ensure that a single float does not contribute unduly to any particular prediction, we can weight each profile as <code>1 / n</code>, where <code>n</code> is the number of profiles in a given time frame contributed by a single float. We can also weight profiles taken farther from the mooring location less than those taken close to the mooring location; however, the choice of how severely to punish profiles taken far from the mooring location makes a considerable difference to the result. One method is to use the inverse of the distance, which produces a rather severe punishment as distance from the centre increases. Here we will use <code>1 / sqrt(distance)</code> to mitigate the penalty. The distance weights we can calculate before binning; the float weights depend on our choice of bins.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">profile_weighted</span> <span class="op">&lt;-</span> <span class="va">profiles</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    distance_km <span class="op">=</span> <span class="fu">s2</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/s2/reference/s2_is_collection.html">s2_distance</a></span><span class="op">(</span>
      <span class="fu">s2</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/s2/reference/s2_lnglat.html">s2_lnglat</a></span><span class="op">(</span><span class="va">longitude</span>, <span class="va">latitude</span><span class="op">)</span>, 
      <span class="fu">s2</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/s2/reference/s2_lnglat.html">s2_lnglat</a></span><span class="op">(</span><span class="va">mooring_lon</span>, <span class="va">mooring_lat</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">/</span> <span class="fl">1000</span>,
    distance_weight <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">distance_km</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">file</span>, <span class="va">longitude</span>, <span class="va">latitude</span>, <span class="va">distance_km</span>, <span class="va">distance_weight</span><span class="op">)</span>

<span class="va">profile_weighted</span>
<span class="co">#&gt; [90m# A tibble: 216 x 5[39m</span>
<span class="co">#&gt;    file                           longitude latitude distance_km distance_weight</span>
<span class="co">#&gt;    [3m[90m&lt;chr&gt;[39m[23m                              [3m[90m&lt;dbl&gt;[39m[23m    [3m[90m&lt;dbl&gt;[39m[23m       [3m[90m&lt;dbl&gt;[39m[23m           [3m[90m&lt;dbl&gt;[39m[23m</span>
<span class="co">#&gt; [90m 1[39m meds/4901167/profiles/R490116…     -[31m51[39m[31m.[39m[31m8[39m     56.1       150.           0.081[4m7[24m</span>
<span class="co">#&gt; [90m 2[39m meds/4901167/profiles/R490116…     -[31m51[39m[31m.[39m[31m5[39m     56.3       139.           0.084[4m7[24m</span>
<span class="co">#&gt; [90m 3[39m meds/4901167/profiles/R490116…     -[31m51[39m[31m.[39m[31m4[39m     56.2       127.           0.088[4m6[24m</span>
<span class="co">#&gt; [90m 4[39m meds/4901163/profiles/R490116…     -[31m48[39m[31m.[39m[31m6[39m     56.7       129.           0.087[4m9[24m</span>
<span class="co">#&gt; [90m 5[39m meds/4901167/profiles/R490116…     -[31m51[39m[31m.[39m[31m1[39m     56.0       107.           0.096[4m8[24m</span>
<span class="co">#&gt; [90m 6[39m meds/4901163/profiles/R490116…     -[31m48[39m[31m.[39m[31m7[39m     56.8       137.           0.085[4m5[24m</span>
<span class="co">#&gt; [90m 7[39m meds/4901167/profiles/R490116…     -[31m51[39m[31m.[39m[31m0[39m     55.8        96.2          0.102 </span>
<span class="co">#&gt; [90m 8[39m meds/4901163/profiles/R490116…     -[31m49[39m[31m.[39m[31m1[39m     56.8       125.           0.089[4m5[24m</span>
<span class="co">#&gt; [90m 9[39m meds/4901167/profiles/R490116…     -[31m50[39m[31m.[39m[31m2[39m     56.5        93.7          0.103 </span>
<span class="co">#&gt; [90m10[39m meds/4901163/profiles/R490116…     -[31m49[39m[31m.[39m[31m3[39m     56.7       117.           0.092[4m4[24m</span>
<span class="co">#&gt; [90m# … with 206 more rows[39m</span></code></pre></div>
<p>The next step is to choose bins that are appropriate to the scale of the problem. In this case, we’re interested in monthly bins (regardless of year) and depth bins 10 decibars in height. These bin sizes reflect the amount of data we have: if we were only summarizing 2019, for which there are many profiles with high-resolution sampling intervals, we may be able to use smaller bins (e.g., one bin per month per year or 1 decibar height).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">levels_binned</span> <span class="op">&lt;-</span> <span class="va">levels_clean</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    pres_bin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">pres</span> <span class="op">/</span> <span class="fl">100</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span> <span class="op">+</span> <span class="fl">50</span>,
    date_bin <span class="op">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pres_bin</span>, <span class="va">date_bin</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">levels_binned</span>
<span class="co">#&gt; [90m# A tibble: 233,909 x 22[39m</span>
<span class="co">#&gt;    pres_bin date_bin file  date                 pres  temp temp_qc n_prof</span>
<span class="co">#&gt;       [3m[90m&lt;dbl&gt;[39m[23m    [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;chr&gt;[39m[23m [3m[90m&lt;dttm&gt;[39m[23m              [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;chr&gt;[39m[23m    [3m[90m&lt;int&gt;[39m[23m</span>
<span class="co">#&gt; [90m 1[39m       50        7 meds… 2011-07-03 [90m12:58:00[39m  6.70  7.24 1            1</span>
<span class="co">#&gt; [90m 2[39m       50        7 meds… 2011-07-03 [90m12:58:00[39m 10.8   6.83 1            1</span>
<span class="co">#&gt; [90m 3[39m       50        7 meds… 2011-07-03 [90m12:58:00[39m 20.1   5.51 1            1</span>
<span class="co">#&gt; [90m 4[39m       50        7 meds… 2011-07-03 [90m12:58:00[39m 30.2   3.85 1            1</span>
<span class="co">#&gt; [90m 5[39m       50        7 meds… 2011-07-03 [90m12:58:00[39m 40.5   3.68 1            1</span>
<span class="co">#&gt; [90m 6[39m       50        7 meds… 2011-07-03 [90m12:58:00[39m 49.9   3.88 1            1</span>
<span class="co">#&gt; [90m 7[39m       50        7 meds… 2011-07-03 [90m12:58:00[39m 59.8   4.01 1            1</span>
<span class="co">#&gt; [90m 8[39m       50        7 meds… 2011-07-03 [90m12:58:00[39m 69     3.95 1            1</span>
<span class="co">#&gt; [90m 9[39m       50        7 meds… 2011-07-03 [90m12:58:00[39m 80.6   3.63 1            1</span>
<span class="co">#&gt; [90m10[39m       50        7 meds… 2011-07-03 [90m12:58:00[39m 90.6   3.94 1            1</span>
<span class="co">#&gt; [90m# … with 233,899 more rows, and 14 more variables: cycle_number [3m[90m&lt;int&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   n_levels [3m[90m&lt;int&gt;[90m[23m, pres_qc [3m[90m&lt;chr&gt;[90m[23m, pres_adjusted [3m[90m&lt;dbl&gt;[90m[23m, pres_adjusted_qc [3m[90m&lt;chr&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   pres_adjusted_error [3m[90m&lt;dbl&gt;[90m[23m, temp_adjusted [3m[90m&lt;dbl&gt;[90m[23m, temp_adjusted_qc [3m[90m&lt;chr&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   temp_adjusted_error [3m[90m&lt;dbl&gt;[90m[23m, psal [3m[90m&lt;dbl&gt;[90m[23m, psal_qc [3m[90m&lt;chr&gt;[90m[23m, psal_adjusted [3m[90m&lt;dbl&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   psal_adjusted_qc [3m[90m&lt;chr&gt;[90m[23m, psal_adjusted_error [3m[90m&lt;dbl&gt;[90m[23m[39m</span></code></pre></div>
<p>Next we can calculate the weights to ensure each profile does not contribute more than its share to the values calculated for a given bin and apply the weights based on distance we calculated above.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">levels_binned_weighted</span> <span class="op">&lt;-</span> <span class="va">levels_binned</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">pres_bin</span>, <span class="va">date_bin</span>, <span class="va">file</span>, <span class="va">n_prof</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>profile_weight <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">profile_weighted</span>, by <span class="op">=</span> <span class="st">"file"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="va">profile_weight</span> <span class="op">*</span> <span class="va">distance_weight</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">pres_bin</span>, <span class="va">date_bin</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="va">weight</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">weight</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pres_bin</span>, <span class="va">date_bin</span>, <span class="va">weight</span>, <span class="va">file</span>, <span class="va">date</span>, <span class="va">pres</span>, <span class="va">temp</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">levels_binned_weighted</span>
<span class="co">#&gt; [90m# A tibble: 233,909 x 28[39m</span>
<span class="co">#&gt;    pres_bin date_bin  weight file  date                 pres  temp temp_qc</span>
<span class="co">#&gt;       [3m[90m&lt;dbl&gt;[39m[23m    [3m[90m&lt;dbl&gt;[39m[23m   [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;chr&gt;[39m[23m [3m[90m&lt;dttm&gt;[39m[23m              [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;chr&gt;[39m[23m  </span>
<span class="co">#&gt; [90m 1[39m       50        7 0.001[4m6[24m[4m7[24m meds… 2011-07-03 [90m12:58:00[39m  6.70  7.24 1      </span>
<span class="co">#&gt; [90m 2[39m       50        7 0.001[4m6[24m[4m7[24m meds… 2011-07-03 [90m12:58:00[39m 10.8   6.83 1      </span>
<span class="co">#&gt; [90m 3[39m       50        7 0.001[4m6[24m[4m7[24m meds… 2011-07-03 [90m12:58:00[39m 20.1   5.51 1      </span>
<span class="co">#&gt; [90m 4[39m       50        7 0.001[4m6[24m[4m7[24m meds… 2011-07-03 [90m12:58:00[39m 30.2   3.85 1      </span>
<span class="co">#&gt; [90m 5[39m       50        7 0.001[4m6[24m[4m7[24m meds… 2011-07-03 [90m12:58:00[39m 40.5   3.68 1      </span>
<span class="co">#&gt; [90m 6[39m       50        7 0.001[4m6[24m[4m7[24m meds… 2011-07-03 [90m12:58:00[39m 49.9   3.88 1      </span>
<span class="co">#&gt; [90m 7[39m       50        7 0.001[4m6[24m[4m7[24m meds… 2011-07-03 [90m12:58:00[39m 59.8   4.01 1      </span>
<span class="co">#&gt; [90m 8[39m       50        7 0.001[4m6[24m[4m7[24m meds… 2011-07-03 [90m12:58:00[39m 69     3.95 1      </span>
<span class="co">#&gt; [90m 9[39m       50        7 0.001[4m6[24m[4m7[24m meds… 2011-07-03 [90m12:58:00[39m 80.6   3.63 1      </span>
<span class="co">#&gt; [90m10[39m       50        7 0.001[4m6[24m[4m7[24m meds… 2011-07-03 [90m12:58:00[39m 90.6   3.94 1      </span>
<span class="co">#&gt; [90m# … with 233,899 more rows, and 20 more variables: n_prof [3m[90m&lt;int&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   cycle_number [3m[90m&lt;int&gt;[90m[23m, n_levels [3m[90m&lt;int&gt;[90m[23m, pres_qc [3m[90m&lt;chr&gt;[90m[23m, pres_adjusted [3m[90m&lt;dbl&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   pres_adjusted_qc [3m[90m&lt;chr&gt;[90m[23m, pres_adjusted_error [3m[90m&lt;dbl&gt;[90m[23m, temp_adjusted [3m[90m&lt;dbl&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   temp_adjusted_qc [3m[90m&lt;chr&gt;[90m[23m, temp_adjusted_error [3m[90m&lt;dbl&gt;[90m[23m, psal [3m[90m&lt;dbl&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   psal_qc [3m[90m&lt;chr&gt;[90m[23m, psal_adjusted [3m[90m&lt;dbl&gt;[90m[23m, psal_adjusted_qc [3m[90m&lt;chr&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   psal_adjusted_error [3m[90m&lt;dbl&gt;[90m[23m, profile_weight [3m[90m&lt;dbl&gt;[90m[23m, longitude [3m[90m&lt;dbl&gt;[90m[23m,[39m</span>
<span class="co">#&gt; [90m#   latitude [3m[90m&lt;dbl&gt;[90m[23m, distance_km [3m[90m&lt;dbl&gt;[90m[23m, distance_weight [3m[90m&lt;dbl&gt;[90m[23m[39m</span></code></pre></div>
<p>The most stragithforward way to aggregate is using <code><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean()</a></code>, which is a good way to get a preliminary view of our results:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://hbiostat.org/R/Hmisc/">Hmisc</a></span><span class="op">)</span>

<span class="va">levels_aggregated</span> <span class="op">&lt;-</span> <span class="va">levels_binned_weighted</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">date_bin</span>, <span class="va">pres_bin</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.finite</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
    temp_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">temp</span>, w <span class="op">=</span> <span class="va">weight</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    temp_q05 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Hmisc/man/wtd.stats.html">wtd.quantile</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">weight</span>, <span class="fl">0.05</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    temp_median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Hmisc/man/wtd.stats.html">wtd.quantile</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">weight</span>, <span class="fl">0.5</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    temp_q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Hmisc/man/wtd.stats.html">wtd.quantile</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">weight</span>, <span class="fl">0.95</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'date_bin' (override with `.groups` argument)</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">levels_aggregated</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">temp_median</span>, y <span class="op">=</span> <span class="va">pres_bin</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_ribbon</span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">temp_q05</span>, xmax <span class="op">=</span> <span class="va">temp_q95</span><span class="op">)</span>,
    alpha <span class="op">=</span> <span class="fl">0.3</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_y_reverse</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">date_bin</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 9 rows containing missing values (geom_point).</span></code></pre></div>
<p><img src="virtual-mooring_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>This is a good first step in your analysis: if the above diagram was not in line with our knowledge of the ocean at this location, it is a clue that some part of our analysis went wrong. However, it is not able to communicate the spread of values that we observed in each bin. Are the profiles for a given month of the year similar over the last 10 years or not?</p>
<p>One technique that allows calculation of error in this way is sampling: we can draw a random sample of size <code>n</code> from the values available for each bin (applying the weights such that values with a higher weight are more likely to be drawn than others). We can repeat this analysis <code>k</code> times and use the distribution of the values we observe for each bin to communicate the uncertainty of our results.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">3948</span><span class="op">)</span>

<span class="va">levels_aggregated_randomized</span> <span class="op">&lt;-</span> <span class="va">levels_binned_weighted</span> <span class="op">%&gt;%</span>
  <span class="fu">crossing</span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>sample_number <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">sample_number</span>, <span class="va">date_bin</span>, <span class="va">pres_bin</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html">sample_n</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
    temp_weighted_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">temp</span>, w <span class="op">=</span> <span class="va">weight</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">pres_bin</span>, <span class="va">date_bin</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
    temp_weighted_mean_q05 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">temp_weighted_mean</span>, <span class="fl">0.05</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    temp_weighted_mean_q50 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">temp_weighted_mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    temp_weighted_mean_q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">temp_weighted_mean</span>, <span class="fl">0.95</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'sample_number', 'date_bin' (override with `.groups` argument)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'pres_bin' (override with `.groups` argument)</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">levels_aggregated_randomized</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">temp_weighted_mean_q50</span>, y <span class="op">=</span> <span class="va">pres_bin</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_ribbon</span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">temp_weighted_mean_q05</span>, xmax <span class="op">=</span> <span class="va">temp_weighted_mean_q95</span><span class="op">)</span>,
    alpha <span class="op">=</span> <span class="fl">0.3</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_y_reverse</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">date_bin</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 12 rows containing missing values (geom_point).</span></code></pre></div>
<p><img src="virtual-mooring_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
</div>
</div>
<div id="sections" class="section level2">
<h2 class="hasAnchor">
<a href="#sections" class="anchor"></a>Sections</h2>
<p>As an example, we’ll choose</p>
<p>43.437, 44.356</p>
<p>-61.515, -41.783</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Dewey Dunnington.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
